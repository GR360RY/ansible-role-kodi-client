---
# tasks file for kodi-client

- name: Create HTPC user .cache/unity directory
  file: path="~{{ htpc_user_username }}/.cache/unity/" state=directory owner={{ htpc_user_username }} group={{ htpc_user_username }} mode=0755

- name: Disable First Login pop-up screen
  file: path="~{{ htpc_user_username }}/.cache/unity/first_run.stamp" state=touch owner={{ htpc_user_username }} group={{ htpc_user_username }} mode=0755

- name: Add Kodi repository
  apt_repository: repo={{ kodi_repo }} state=present

- name: Make sure Kodi is installed
  apt: name='kodi' update_cache=yes

- name: Make sure Kodi Config folders are available
  file: path={{ item }} state=directory owner={{ htpc_user_username }} group={{ htpc_user_username }} mode=0755
  with_items:
    - "~{{ htpc_user_username }}/.kodi/"
    - "~{{ htpc_user_username }}/.kodi/userdata"

- name: Update sources location
  template: src=sources.xml.j2 dest="~{{ htpc_user_username }}/.kodi/userdata/sources.xml" owner={{ htpc_user_username }} group={{ htpc_user_username }} mode=0755

- name: Update advancedsettings.xml
  template: src=advancedsettings.xml.j2 dest=~{{ htpc_user_username }}/.kodi/userdata/advancedsettings.xml owner={{ htpc_user_username }} group={{ htpc_user_username }} mode=0644

- name: Setup Autologin for HTPC User
  template: src=etc_lightdm_lightdm.conf.j2 dest=/etc/lightdm/lightdm.conf owner=root group=root mode=0664

- name: Get HTPC User ID
  command: /usr/bin/id -u {{ htpc_user_username }}
  register: htpc_user_id
  changed_when: False

- name: Get DBUS PATH for HTPC user in AccountService
  shell: dbus-send --print-reply=literal --system --dest=org.freedesktop.Accounts /org/freedesktop/Accounts org.freedesktop.Accounts.FindUserById int64:{{ htpc_user_id.stdout }}
  register: xbmc_dbus_path
  changed_when: False

- name: Set Default Lightdm session to Kodi
  shell: dbus-send --print-reply --system --dest=org.freedesktop.Accounts {{ xbmc_dbus_path.stdout }} org.freedesktop.Accounts.User.SetXSession string:'XBMC'
  when: not kodi_enable_ubuntu_desktop

- name: Set Default Lightdm session to Ubuntu
  shell: dbus-send --print-reply --system --dest=org.freedesktop.Accounts {{ xbmc_dbus_path.stdout }} org.freedesktop.Accounts.User.SetXSession string:'ubuntu'
  when: kodi_enable_ubuntu_desktop

- name: Make sure ~/.config/autostart directory is available
  file: state=directory dest={{ item }} owner={{ htpc_user_username }} group={{ htpc_user_username }} mode=0700
  with_items:
    - "~{{ htpc_user_username }}/.config/"
    - "~{{ htpc_user_username }}/.config/autostart/"

- name: Startup Kodi automatically on login in full screen mode
  template: src=kodi.desktop.j2 dest=~{{ htpc_user_username }}/.config/autostart/kodi.desktop owner={{ htpc_user_username }} group={{ htpc_user_username }} mode=0664

- name: Add script to disable screensaver
  copy: src=disable_screensaver dest=/usr/bin/disable_screensaver owner=root group=root mode=0755

- name: Disable screensaver both in Unity and Xserver on HTPC user login
  copy: src=disable_screensaver.desktop dest=~{{ htpc_user_username }}/.config/autostart/disable_screensaver.desktop owner={{ htpc_user_username }} group={{ htpc_user_username }} mode=0664
  
